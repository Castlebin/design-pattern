# 美团：字节码增强技术探索  
  https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html

JVM对于字节码是有规范要求的，那么看似杂乱的十六进制符合什么结构呢？  
JVM规范要求每一个字节码文件都要由十部分按照固定的顺序组成，整体结构如图 所示：
![JVM规定的字节码结构](./pic/bytecode_structure.png)

## 各部分简介

![字节码示例](./pic/class_bytecode_head_example.png)

1. 魔数（Magic Number）  
    所有的.class文件的前四个字节都是魔数，魔数的固定值为：0xCAFEBABE。
    魔数放在文件开头，JVM可以根据文件的开头来判断这个文件是否可能是一个.class文件，
    如果是，才会继续进行之后的操作。
2. 版本号  
    版本号为魔数之后的4个字节，前两个字节表示次版本号（Minor Version），后两个字节表示主版本号（Major Version）。
    如版本号为“00 00 00 34”，次版本号转化为十进制为0，主版本号转化为十进制为52，
    在Oracle官网中查询序号52对应的主版本号为1.8，所以编译该文件的Java版本号为1.8.0。
3. 常量池  
    紧接着主版本号之后的字节为常量池入口。常量池中存储两类常量：字面量与符号引用。
    字面量为代码中声明为Final的常量值，符号引用如类和接口的全局限定名、字段的名称和描述符、方法的名称和描述符。
    常量池整体上分为两部分：常量池计数器以及常量池数据区，如下图所示。
![常量池](./pic/constant_pool.png)
    - 常量池计数器（constant_pool_count）：  
        由于常量的数量不固定，所以需要先放置两个字节来表示常量池容量计数值  
        示例图中，将十六进制的24转化为十进制值为36，排除掉下标“0”，也就是说，这个类文件中共有35个常量
    - 常量池数据区：  
        数据区是由（constant_pool_count-1）个cp_info结构组成，一个cp_info结构对应一个常量。  
        在字节码中共有14种类型的cp_info（如下图所示），每种类型的结构都是固定的。  
        ![cp_info 类型](./pic/cp_info_types.png)
4. 访问标志  
   常量池结束之后的两个字节，描述该Class是类还是接口，以及是否被Public、Abstract、Final等修饰符修饰。
   JVM规范规定了如下图的访问标志（Access_Flag）。
   ![访问标志](./pic/access_flag_types.png)
   需要注意的是，JVM并没有穷举所有的访问标志，而是使用按位或操作来进行描述的，
   比如某个类的修饰符为Public Final，则对应的访问修饰符的值为ACC_PUBLIC | ACC_FINAL，即0x0001 | 0x0010=0x0011。
5. 当前类名  
访问标志后的两个字节，描述的是当前类的全限定名。这两个字节保存的值为常量池中的索引值，根据索引值就能在常量池中找到这个类的全限定名。

6. 父类名称  
当前类名后的两个字节，描述父类的全限定名，同上，保存的也是常量池中的索引值。

7. 接口信息  
父类名称后为两字节的接口计数器，描述了该类或父类实现的接口数量。紧接着的n个字节是所有接口名称的字符串常量的索引值。

8. 字段表  
   
   